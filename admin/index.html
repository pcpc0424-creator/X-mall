<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대시보드 - X-mall 관리자</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">X-<span>mall</span></a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메인</div>
                </div>
                <a href="index.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    대시보드
                </a>
                <div class="nav-section">
                    <div class="nav-section-title">관리</div>
                </div>
                <a href="members.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                        <path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    회원 관리
                </a>
                <a href="orders.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <path d="M16 10a4 4 0 01-8 0"/>
                    </svg>
                    주문 관리
                </a>
                <a href="products.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    상품 관리
                </a>
                <a href="points.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    포인트 관리
                </a>
                <a href="withdrawals.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    출금 관리
                </a>
                <a href="settings.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    설정
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">A</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="adminUserName">관리자</div>
                        <div class="sidebar-user-role">최고 관리자</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16,17 21,12 16,7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    로그아웃
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                    <h1 class="page-title">대시보드</h1>
                </div>
                <div class="header-right">
                    <a href="/X-mall/index.html" class="back-to-site">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <polyline points="15,3 21,3 21,9"/>
                            <line x1="10" y1="14" x2="21" y2="3"/>
                        </svg>
                        사이트 보기
                    </a>
                </div>
            </header>

            <!-- Content -->
            <div class="content-area">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>총 매출</h3>
                            <div class="stat-value" id="statRevenue">₩0</div>
                            <div class="stat-change positive" id="statRevenueChange">
                                <span>이번 달</span>
                            </div>
                        </div>
                        <div class="stat-icon sales">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>총 주문</h3>
                            <div class="stat-value" id="statOrders">0건</div>
                            <div class="stat-change" id="statOrdersChange">
                                <span>전체</span>
                            </div>
                        </div>
                        <div class="stat-icon orders">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <path d="M16 10a4 4 0 01-8 0"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>총 회원</h3>
                            <div class="stat-value" id="statMembers">0명</div>
                            <div class="stat-change" id="statMembersChange">
                                <span>전체</span>
                            </div>
                        </div>
                        <div class="stat-icon customers">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 00-3-3.87"/>
                                <path d="M16 3.13a4 4 0 010 7.75"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>대기 출금</h3>
                            <div class="stat-value" id="statWithdrawals">0건</div>
                            <div class="stat-change" id="statWithdrawalsChange">
                                <span>처리 필요</span>
                            </div>
                        </div>
                        <div class="stat-icon products">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">매출 현황</h2>
                            <select class="form-control form-select" style="width: auto;" id="salesPeriod" onchange="updateSalesChart()">
                                <option value="7">최근 7일</option>
                                <option value="30">최근 30일</option>
                            </select>
                        </div>
                        <div class="card-body">
                            <div style="position: relative; height: 250px;">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">회원 등급 분포</h2>
                        </div>
                        <div class="card-body">
                            <div style="position: relative; height: 250px;">
                                <canvas id="memberChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">최근 주문</h2>
                        <a href="orders.html" class="btn btn-sm btn-outline">전체 보기</a>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>주문번호</th>
                                        <th>고객명</th>
                                        <th>상품</th>
                                        <th>금액</th>
                                        <th>상태</th>
                                        <th>주문일</th>
                                    </tr>
                                </thead>
                                <tbody id="recentOrdersBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">로딩 중...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Recent Withdrawals -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">대기 중인 출금 신청</h2>
                        <a href="withdrawals.html" class="btn btn-sm btn-outline">전체 보기</a>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>신청자</th>
                                        <th>은행</th>
                                        <th>계좌번호</th>
                                        <th>금액</th>
                                        <th>신청일</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingWithdrawalsBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">로딩 중...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/admin.js"></script>
    <script>
        let salesChart = null;
        let memberChart = null;

        async function initDashboard() {
            try {
                // Load dashboard stats
                const stats = await api.get('/admin/dashboard/stats');
                if (stats.success) {
                    document.getElementById('statRevenue').textContent = formatCurrency(stats.data.totalRevenue || 0);
                    document.getElementById('statOrders').textContent = (stats.data.totalOrders || 0) + '건';
                    document.getElementById('statMembers').textContent = (stats.data.totalMembers || 0) + '명';
                    document.getElementById('statWithdrawals').textContent = (stats.data.pendingWithdrawals || 0) + '건';
                }

                // Load recent orders
                const orders = await api.get('/admin/orders?limit=5');
                renderRecentOrders(orders.data?.orders || []);

                // Load pending withdrawals
                const withdrawals = await api.get('/admin/withdrawals?status=pending&limit=5');
                renderPendingWithdrawals(withdrawals.data?.withdrawals || []);

                // Init charts
                initSalesChart();
                initMemberChart(stats.data);

            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function renderRecentOrders(orders) {
            const tbody = document.getElementById('recentOrdersBody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">주문이 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><strong>#${order.order_number || order.id?.slice(0, 8)}</strong></td>
                    <td>${order.user?.name || '-'}</td>
                    <td>${order.items?.[0]?.product_name || '-'} ${order.items?.length > 1 ? `외 ${order.items.length - 1}건` : ''}</td>
                    <td>${formatCurrency(order.total_amount)}</td>
                    <td>${orderStatusBadge(order.status)}</td>
                    <td>${formatDate(order.created_at)}</td>
                </tr>
            `).join('');
        }

        function renderPendingWithdrawals(withdrawals) {
            const tbody = document.getElementById('pendingWithdrawalsBody');
            if (withdrawals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">대기 중인 출금 신청이 없습니다</td></tr>';
                return;
            }

            tbody.innerHTML = withdrawals.map(w => `
                <tr>
                    <td>${w.user?.name || '-'}</td>
                    <td>${w.bank_name}</td>
                    <td>${w.account_number}</td>
                    <td class="fw-600">${formatCurrency(w.amount)}</td>
                    <td>${formatDate(w.created_at)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn" onclick="approveWithdrawal('${w.id}')" title="승인">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20,6 9,17 4,12"/>
                                </svg>
                            </button>
                            <button class="action-btn delete" onclick="rejectWithdrawal('${w.id}')" title="거절">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function approveWithdrawal(id) {
            if (!confirm('이 출금 신청을 승인하시겠습니까?')) return;
            try {
                await api.put(`/admin/withdrawals/${id}`, { status: 'approved' });
                showToast('출금이 승인되었습니다.');
                initDashboard();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function rejectWithdrawal(id) {
            const reason = prompt('거절 사유를 입력하세요:');
            if (!reason) return;
            try {
                await api.put(`/admin/withdrawals/${id}`, { status: 'rejected', reject_reason: reason });
                showToast('출금이 거절되었습니다.');
                initDashboard();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function initSalesChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            // Sample data - will be replaced with API data
            const labels = [];
            const values = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('ko-KR', { weekday: 'short' }));
                values.push(Math.floor(Math.random() * 500000) + 100000);
            }

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '매출',
                        data: values,
                        borderColor: '#6c63ff',
                        backgroundColor: 'rgba(108, 99, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₩' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function initMemberChart(stats) {
            const ctx = document.getElementById('memberChart');
            if (!ctx) return;

            const dealerCount = stats?.dealerCount || 0;
            const consumerCount = stats?.consumerCount || 0;

            memberChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['대리점', '소비자'],
                    datasets: [{
                        data: [dealerCount || 1, consumerCount || 1],
                        backgroundColor: ['#6c63ff', '#ff6b9d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSalesChart() {
            // Update chart based on period selection
            const period = document.getElementById('salesPeriod').value;
            // In real implementation, fetch data from API
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
